# AII Monitor (Autonomic Instability Index)

M5StickC Plus、Pulse Sensor、およびUnit Puzzle (8x8 LED Matrix) を用いた、自律神経の「揺らぎ」を可視化するシステムです。

## 0. 目的
軽い認知負荷（簡単なクイズ等）でも生じる「自律神経安定性の崩れ（揺らぎ増大）」をリアルタイムで検出し、8x8のLED面積として直感的に提示します。これを **AII (Autonomic Instability Index)** と定義します。

## 1. ハードウェア構成
*   **制御**: M5StickC Plus
*   **センサ**: SparkFun Pulse Sensor (PPG)
    *   接続: GPIO 26 (ADC入力)
*   **表示 (外部)**: M5Stack Unit Puzzle (8x8 RGB LED WS2812E)
    *   接続: Grove Port (G33/G32) - コード内ではG33(Yellow)に設定中
    *   **注意**: Unit Puzzleは5V電源が必要です。
*   **表示 (内部)**: M5StickC Plus 本体LCD
    *   分割画面による波形モニタリングと仮想LEDマトリクス表示

## 2. アルゴリズム仕様 (AII算出)

### 2.1 データフロー
1.  **IBI取得**: 100HzでPPG信号を取得し、ピーク間の時間 (Inter-Beat Interval) を算出。
2.  **RMSSD算出**: 直近15秒間のIBIから心拍変動指標(RMSSD)を計算。
    $$ R(t) = \sqrt{\frac{1}{N-1}\sum (IBI_k - IBI_{k-1})^2} $$
3.  **ハイブリッド揺らぎ指標 $F(t)$**:
    *   差分 $D(t) = |R(t) - R(t-1)|$ （瞬間の変化）
    *   分散 $V(t) = \text{Variance}(R)$ （構造的な不安定さ）
    *   統合 $F(t) = D(t) + \lambda V(t)$ （推奨 $\lambda = 2.0$）
4.  **非線形変換**:
    $$ s(t) = 1 - e^{-k F(t)} $$ ($k = 6.5$)
5.  **面積算出**:
    $$ A(t) = \lfloor 64 \cdot s(t) \rfloor $$ (最大56に制限)

### 2.2 誤検知対策
非生体信号（壁や机などからの反射光）による誤動作を防ぐため、以下のフィルターを実装済みです。
1.  **DCレベル監視**: 信号レベルが極端に低い（指なし）、または高い（飽和）場合は無視。
2.  **AC振幅監視**: 脈動成分（Amplitude）が一定以下の場合、静止物とみなして無視。
3.  **指離れ時のリセット**: 指が検知されない場合、ストレス表示を速やかに緑色（安定）へ戻します。

## 3. 操作方法とデータログ

USB接続中、シリアルモニタ (115200bps) にリアルタイムでデータが出力されますが、本体内(SPIFFS)にもCSVデータが蓄積されます。

### ボタン操作
*   **Button A (正面 M5ボタン)**: **データ吸い出し (Dump)**
    *   計測を一時停止し、保存されている `data.csv` の内容をシリアルモニタに一気に出力します。
    *   PC側でログを保存したい場合に使用します。
*   **Button B (側面 右ボタン)**: **データ消去 / 新規セッション開始**
    *   保存されているログファイルを削除し、新しい計測を開始します。
    *   起動時にも押す必要があります。

### CSVフォーマット
```csv
timestamp_ms, RMSSD_sec, D, V, F, A_disp, Amp, IBI_ms
```

## 4. パラメータ設定
*   **窓長**: 15秒 (短期的な反応と安定性のバランス)
*   **$\lambda$ (Lambda)**: 2.0 (固定。実験により推奨値として設定)
*   **$k$**: 6.5 (感度調整用)

## 5. 免責事項
本システムが表示する指標は、医学的な診断に用いる生理学的ストレス値ではありません。あくまで自律神経安定性の揺らぎを可視化する実験的指標です。
